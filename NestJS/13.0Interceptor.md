# μΈν„°μ…‰ν„° (Interceptor)

μΈν„°μ…‰ν„°λ” μ”μ²­κ³Ό μ‘λ‹µμ„ κ°€λ΅μ±„μ„ λ³€ν•μ„ κ°€ν•  μ μλ” μ»΄ν¬λ„νΈμ΄λ‹¤.

![](https://wikidocs.net/images/page/158655/1.png)

μΈν„°μ…‰ν„°λ” AOP(κ΄€μ  μ§€ν–¥ ν”„λ΅κ·Έλλ°)μ— μν–¥μ„ λ§μ΄ λ°›μ•λ‹¤. μΈν„°μ…‰ν„°λ¥Ό μ΄μ©ν•λ©΄ λ‹¤μκ³Ό κ°™μ€ κΈ°λ¥μ„ μν–‰ν•  μ μκ² λλ‹¤.  

- λ©”μ„λ“ μ‹¤ν–‰ μ „/ν›„ μ¶”κ°€ λ΅μ§ λ°”μΈλ”©
- ν•¨μμ—μ„ λ°ν™λ κ²°κ³Όλ¥Ό λ³€ν™
- ν•¨μμ—μ„ λμ Έμ§„ μμ™Έλ¥Ό λ³€ν™
- κΈ°λ³Έ κΈ°λ¥μ λ™μ‘μ„ ν™•μ¥
- νΉμ • μ΅°κ±΄μ— λ”°λΌ κΈ°λ¥μ„ μ™„μ „ν μ¬μ •μ(μ: μΊμ‹±)

μΈν„΄μ…‰ν„°μ λ‚΄λ¶€ κµ¬ν„μ„ λ“¤μ—¬λ‹¤ λ³΄κΈ° μ „μ— μΈν„°μ…‰ν„°λ¥Ό ν™μ©ν•λ” λ°©λ²•μ„ λ¨Όμ € μ‚΄ν΄λ³΄λ„λ΅ ν•κ² λ‹¤. λΌμ°νΈ ν•Έλ“¤λ¬κ°€ μ”μ²­μ„ μ²λ¦¬ν•κΈ° μ „/ν›„μ— μ–΄λ–¤ λ΅κ·Έλ¥Ό λ‚¨κΈ°κ³  μ‹¶μ€ μ”κµ¬μ‚¬ν•­μ΄ μλ‹¤. μ΄λ¥Ό μ„ν•΄ LoggingInterceptorλ¥Ό λ§λ“¤μ–΄ λ³΄μ.

```ts
import { Injectable, NestInterceptor, ExecutionContext, CallHandler } from '@nestjs/common';
import { Observable } from 'rxjs';
import { tap } from 'rxjs/operators';

@Injectable()
export class LoggingInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    console.log('Before...');

    const now = Date.now();
    return next
      .handle()
      .pipe(
        tap(() => console.log(`After... ${Date.now() - now}ms`)),
      );
  }
}
```

L6: μΈν„°μ…‰ν„°λ” @nestjs/common ν¨ν‚¤μ§€μ—μ„ μ κ³µν•λ” NestInterceptor μΈν„°νμ΄μ¤λ¥Ό κµ¬ν„ν• ν΄λμ¤μ…λ‹λ‹¤.

L7: NestInterceptor μΈν„°νμ΄μ¤μ intercept ν•¨μλ¥Ό κµ¬ν„ν•΄μ•Ό ν•©λ‹λ‹¤.

L8: μ”μ²­μ΄ μ „λ‹¬λκΈ° μ „ λ΅κ·Έλ¥Ό μ¶λ ¥ν•©λ‹λ‹¤.

L14: μ”μ²­μ„ μ²λ¦¬ν• ν›„ λ΅κ·Έλ¥Ό μ¶λ ¥ν•©λ‹λ‹¤.

μ΄μ  μ΄ μΈν„°μ…‰ν„°λ¥Ό μ μ©ν•΄ λ³΄μ. μ•μ„ λ°°μ› λ λ‹¤λ¥Έ μ»΄ν¬λ„νΈμ™€ μ μ‚¬ν• λ°©μ‹μΌλ΅ μ μ©ν•  μ μλ‹¤. νΉμ • μ»¨νΈλ΅¤λ¬λ‚ λ©”μ„λ“μ— μ μ©ν•κ³  μ‹¶λ‹¤λ©΄ `@UseInterceptors()`λ¥Ό μ΄μ©ν•λ©΄ λλ‹¤. μ—¬κΈ°μ„λ” μ „μ—­μΌλ΅ μ μ©ν•΄ λ³΄μ.

```ts
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { LoggingInterceptor } from './logging.interceptor';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
    ...
  app.useGlobalInterceptors(new LoggingInterceptor());
  await app.listen(3000);
}
bootstrap();
```

μ΄μ  μ–΄λ–¤ μ”μ²­μ„ λ³΄λ‚΄λ³΄λ©΄ μ„λ²„ μ½μ†”μ— λ΅κ·Έκ°€ μ°νλ” κ²ƒμ„ λ³Ό μ μλ‹¤.

```bash
Before...
After... 2ms
```

NestInterceptorμ μ •μλ¥Ό μΆ€ λ” μμ„Έν μ•μ•„λ³΄μ.

```ts
export interface NestInterceptor<T = any, R = any> {
    intercept(context: ExecutionContext, next: CallHandler<T>): Observable<R> | Promise<Observable<R>>;
}

export interface CallHandler<T = any> {
    handle(): Observable<T>;
}
```

κµ¬ν„ν•΄μ•Όν•λ” interceptμ— μ „λ‹¬λλ” μΈμκ°€ 2κ° μλ‹¤. ExecutionContextλ” 10μ¥ κ°€λ“μ—μ„ μ„¤λ…ν–λ κ²ƒκ³Ό λ™μΌν• μ»¨ν…μ¤νΈμ΄λ‹¤. λ‘ λ²μ§Έ μΈμλ” CallHandlerμΈλ°, μ΄ μΈν„°νμ΄μ¤λ” handle() λ©”μ„λ“λ¥Ό κµ¬ν„ν•΄μ•Ό ν•λ‹¤. handle() λ©”μ„λ“λ” λΌμ°νΈ ν•Έλ“¤λ¬μ—μ„ μ „λ‹¬λ μ‘λ‹µ μ¤νΈλ¦Όμ„ λλ ¤μ£Όκ³  RxJSμ Observableλ΅ κµ¬ν„λμ–΄ μλ‹¤. λ§μ•½ μΈν„°μ…‰ν„°μ—μ„ ν•Έλ“¤λ¬κ°€ μ κ³µν•λ” handle() λ©”μ„λ“λ¥Ό νΈμ¶ν•μ§€ μ•μΌλ©΄ λΌμ°ν„° ν•Έλ“¤λ¬κ°€ λ™μ‘μ„ ν•μ§€ μ•λ”λ‹¤. handle()μ„ νΈμ¶ν•κ³  Observableμ„ μμ‹ ν• ν›„μ— μ‘λ‹µ μ¤νΈλ¦Όμ— μ¶”κ°€ μ‘μ—…μ„ μν–‰ν•  μ μλ” κ²ƒμ΄λ‹¤. LoggingInterceptor κµ¬ν„μ—μ„ λ³΄μ•λ κ²ƒμ²λΌ λ§μ΄λ‹¤. μ‘λ‹µμ„ λ‹¤λ£¨λ” λ°©λ²•μ€ RxJSμ—μ„ μ κ³µν•λ” μ—¬λ¬κ°€μ§€ λ©”μ„λ“λ΅ κµ¬ν„μ΄ κ°€λ¥ν•λ‹¤. μ²«λ²μ§Έ μμ—μ„λ” tap()μ„ μ‚¬μ©ν–λ‹¤.

> π’΅ RxJSκ°€ μ κ³µν•λ” λ‹¤λ¥Έ λ©”μ„λ“λ¥Ό μ‚¬μ©ν•λ” λ°©μ‹μ€ μ΄ μ±…μ λ²”μ„λ¥Ό λ„μ–΄μ„λ” κ²ƒμΌλ΅ RxJSλ¥Ό λ‹¤λ£¨λ” λ‹¤λ¥Έ μλ£λ¥Ό μ°Έκ³ ν•μ‹κΈ° λ°”λλ‹λ‹¤.
